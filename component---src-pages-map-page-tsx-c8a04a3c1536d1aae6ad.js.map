{"version":3,"sources":["webpack:///./src/pages/MapPage.tsx","webpack:///./src/image/place.svg","webpack:///./src/utils/tileTree.ts","webpack:///./src/components/MeshFeature.tsx","webpack:///./src/components/GrayScaleFilter.tsx","webpack:///./src/components/MapApp.tsx"],"names":["buffer","circle","units","withStyles","theme","createStyles","root","autoSizerWrapper","height","props","Object","_emotion_core__WEBPACK_IMPORTED_MODULE_0__","className","classes","_material_ui_core_AppBar__WEBPACK_IMPORTED_MODULE_2___default","a","position","_material_ui_core_Toolbar__WEBPACK_IMPORTED_MODULE_3___default","_material_ui_core_Typography__WEBPACK_IMPORTED_MODULE_4___default","variant","react_virtualized__WEBPACK_IMPORTED_MODULE_7__","_ref","width","_components_MapApp__WEBPACK_IMPORTED_MODULE_9__","feature","module","exports","TileSet","options","this","tileUrl","url","tileTree","treeIncludesTile","tile","x","y","z","hasOwnProperty","toString","tile2tree","_x$toString","_this$tileTree$z$toSt","_this$tileTree$z$toSt2","fetchTiles","tiles","_this","Promise","resolve","tasks","map","fetchTile","all","then","data","_this2","fetchUrl","replace","fetch","res","ok","Error","blob","tileWithURL","assign","URL","createObjectURL","catch","undefined","isRequireFetch","_this3","every","setTileUrlFromTree","_this4","filter","updateTiles","_callee","newTiles","tilesInTree","tilesShouldFetch","fetchedTiles","_this5","regenerator_default","wrap","_context","prev","next","sent","abrupt","concat","stop","colorScale","scaleSequential","interpolateSpectral","domain","sizeScale","scaleLinear","range","MeshRect","projection","val","properties","center","geometry","coordinates","size","Math","abs","scale","core_browser_esm","fill","fillOpacity","style","mixBlendMode","filterMatrix","GrayScaleFilter","id","type","values","join","d3tile","require","Map","state","fetchStatus","_projection","geoMercator","_tileSet","_getTileCoordinates","_this$props","PI","translate","v","index","array","mag","_fetchTiles","componentDidMount","console","log","geojson","render","_this$props2","fitExtent","path","geoPath","tileCoords","renderTiles","setState","components_GrayScaleFilter","opacity","key","xlinkHref","d","points","features","ftr","MeshFeature","Place","transform","React","transition","stroke","palette","primary","main","strokeWidth"],"mappings":"wOAYMA,EAASC,YADA,CAAC,OAAQ,OACM,IAAM,CAClCC,MAAO,WA0BMC,cAvBA,SAACC,GAAD,OACbC,IAAa,CACXC,KAAM,GACNC,iBAAkB,CAChBC,OAAQ,yBAmBCL,CAbiC,SAACM,GAAD,OAC9CC,OAAAC,EAAA,EAAAD,CAAA,OAAKE,UAAWH,EAAMI,QAAQP,MAC5BI,OAAAC,EAAA,EAAAD,CAACI,EAAAC,EAAD,CAAQC,SAAS,UACfN,OAAAC,EAAA,EAAAD,CAACO,EAAAF,EAAD,KACEL,OAAAC,EAAA,EAAAD,CAACQ,EAAAH,EAAD,CAAYI,QAAQ,MAApB,cAGJT,OAAAC,EAAA,EAAAD,CAAA,OAAKE,UAAWH,EAAMI,QAAQN,kBAC5BG,OAAAC,EAAA,EAAAD,CAACU,EAAA,EAAD,KAAY,SAAAC,GAAA,IAAGC,EAAHD,EAAGC,MAAOd,EAAVa,EAAUb,OAAV,OAAuBE,OAAAC,EAAA,EAAAD,CAACa,EAAA,EAAD,CAAQD,MAAOA,EAAOd,OAAQA,EAAQgB,QAASxB,6BClCxFyB,EAAAC,QAAA,qsBC6HeC,mDA5Fb,SAAAA,EAAYC,QAA8B,IAA9BA,MAA0B,IACpCC,KAAKC,QAAUF,EAAQG,KAAO,qDAC9BF,KAAKG,SAAW,8BAGVC,iBAAR,SAAyBC,GAAqB,IACpCC,EAAYD,EAAZC,EAAGC,EAASF,EAATE,EAAGC,EAAMH,EAANG,EACd,OACER,KAAKG,SAASM,eAAeD,EAAEE,aAC/BV,KAAKG,SAASK,EAAEE,YAAYD,eAAeH,EAAEI,aAC7CV,KAAKG,SAASK,EAAEE,YAAYJ,EAAEI,YAAYD,eAAeF,EAAEG,eAIvDC,UAAR,SAAkBN,GAAmB,IAEcO,EAAAC,EADzCP,EAAiBD,EAAjBC,EAAGC,EAAcF,EAAdE,EAAGC,EAAWH,EAAXG,EAAGN,EAAQG,EAARH,IACjB,GAAKF,KAAKG,SAASM,eAAeD,EAAEE,YAM7B,GAAKV,KAAKG,SAASK,EAAEE,YAAYD,eAAeH,EAAEI,YAKvDV,KAAKG,SAASK,EAAEE,YAAYJ,EAAEI,YAAYH,EAAEG,YAAcR,MALU,KAAAY,EACpEd,KAAKG,SAASK,EAAEE,YAAYJ,EAAEI,cAA9BI,EAAA,IACGP,EAAEG,YAAaR,EADlBY,QANAd,KAAKG,SAASK,EAAEE,cAAhBG,EAAA,IACGP,EAAEI,cADLE,EAAA,IAEKL,EAAEG,YAAaR,EAFpBU,GAAAC,MAcIE,WAAR,SAAmBC,GAAuC,IAAAC,EAAAjB,KACxD,OAAO,IAAIkB,QAAQ,SAAAC,GACjB,IAAMC,EAAQJ,EAAMK,IAAI,SAAAhB,GAAI,OAAIY,EAAKK,UAAUjB,EAAMY,EAAKhB,WAC1DiB,QAAQK,IAAIH,GAAOI,KAAK,SAACC,GACvBN,EAAQM,UAINH,UAAR,SAAkBjB,EAAYH,GAAmC,IAAAwB,EAAA1B,KACvDM,EAAYD,EAAZC,EAAGC,EAASF,EAATE,EAAGC,EAAMH,EAANG,EACRmB,EAAWzB,EAAI0B,QAAQ,cAAkBpB,EAA9B,IAAmCF,EAAnC,IAAwCC,GAEzD,OAAOsB,MAAMF,GACVH,KAAK,SAAAM,GACJ,IAAKA,EAAIC,GAAI,MAAM,IAAIC,MACvB,OAAOF,EAAIG,SAEZT,KAAK,SAAAS,GACJ,IAAMC,EAAwBrD,OAAAsD,OAAA,GACzB9B,EADyB,CAE5BH,IAAKkC,IAAIC,gBAAgBJ,KAG3B,OADAP,EAAKf,UAAUuB,GACRA,IAERI,MAAM,WACL,IAAMJ,EAAwBrD,OAAAsD,OAAA,GACzB9B,EADyB,CAE5BH,SAAKqC,IAGP,OADAb,EAAKf,UAAUuB,GACRA,OAMNM,eAAP,SAAsBxB,GAAwB,IAAAyB,EAAAzC,KAC5C,OAAQgB,EAAM0B,MAAM,SAAArC,GAAI,OAAIoC,EAAKrC,iBAAiBC,QAG7CsC,mBAAP,SAA0B3B,GAA8B,IAAA4B,EAAA5C,KACtD,OAAOgB,EACJ6B,OAAO,SAAAxC,GAAI,OAAIuC,EAAKxC,iBAAiBC,KACrCgB,IAAI,SAAAhB,GAAI,OAAAxB,OAAAsD,OAAA,GACJ9B,EADI,CAEPH,IAAK0C,EAAKzC,SAASE,EAAKG,GAAGH,EAAKC,GAAGD,EAAKE,UAIjCuC,0CAAb,SAAAC,EAAyBC,GAAzB,IAAAC,EAAAC,EAAAC,EAAAC,EAAApD,KAAA,OAAAqD,EAAAnE,EAAAoE,KAAA,SAAAC,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,cACQR,EAAcjD,KAAK2C,mBAAmBK,EAASH,OAAO,SAAAxC,GAAI,OAAI+C,EAAKhD,iBAAiBC,MAEpF6C,EAAmBF,EAASH,OAAO,SAAAxC,GAAI,OAAK+C,EAAKhD,iBAAiBC,KAH1EkD,EAAAE,KAAA,EAK4CzD,KAAKe,WAAWmC,GAL5D,cAKQC,EALRI,EAAAG,KAAAH,EAAAI,OAAA,YAAAC,OAOaX,EAAgBE,IAP7B,wBAAAI,EAAAM,SAAAd,EAAA/C,uFCjGI8D,EAAaC,YAAgBC,KAA2CC,OAAO,CAAC,IAAM,IACtFC,EAAYC,cACfF,OAAO,CAAC,EAAG,MACXG,MAAM,CAAC,EAAG,IAqBEC,EAnBkC,SAACzF,GAAiB,IACzDe,EAAwBf,EAAxBe,QAAS2E,EAAe1F,EAAf0F,WACTC,EAAQ5E,EAAQ6E,WAAhBD,IACFE,EAASH,EAAW3E,EAAQ+E,SAASC,aACrCC,EAAOC,KAAKC,IAAKZ,EAAUK,GAAOD,EAAWS,QAAW,QAE9D,OACElG,OAAAmG,EAAA,EAAAnG,CAAA,QACEoG,KAAMnB,EAAWS,GACjBW,YAAa,GACb5E,EAAGmE,EAAO,GAAKG,EAAO,EACtBrE,EAAGkE,EAAO,GAAKG,EAAO,EACtBnF,MAAOmF,EACPjG,OAAQiG,EACRO,MAAO,CAAEC,aAAc,eC3BvBC,EAAe,CAAC,2BAA4B,2BAA4B,2BAA4B,aAY3FC,EANyC,SAAC1G,GAAD,OACtDC,OAAAmG,EAAA,EAAAnG,CAAA,UAAQ0G,GAAI3G,EAAM2G,IAChB1G,OAAAmG,EAAA,EAAAnG,CAAA,iBAAe2G,KAAK,SAASC,OAAQJ,EAAaK,KAAK,2BCbrDC,EAASC,EAAQ,KAAWvF,KA2C5BwF,sJACKC,MAAe,CACtBC,YAAa,SAEfC,YAA6BC,gBAC7BC,SAAW,IAAIpG,EAAQ,CAAEI,IAAK,8DAEtBiG,oBAAsB,SAAC7B,GAAsC,IAAA8B,EACzCnF,EAAKrC,MAAvBa,EAD2D2G,EAC3D3G,MAAOd,EADoDyH,EACpDzH,OAef,OAZsBgH,IACnBf,KAAK,CAHY,IAGXnF,EAHW,IAGEd,IACnBoG,MAA2B,EAArBT,EAAWS,QAAcF,KAAKwB,GAJnB,KAKjBC,UAAUhC,EAAW,CAAC,EAAG,IAAIjD,IAAI,SAAAkF,GAAC,OALjB,IAKqBA,IAHnBZ,GAInBtE,IAAI,SAAChB,EAA2CmG,EAAeC,GAA3D,OAAA5H,OAAAsD,OAAA,GACA9B,EADA,CAEHqG,IARgB,IAShBnB,GAAOlF,EAAKG,EAAV,IAAeH,EAAKC,EAApB,IAAyBD,EAAKE,EAChCwE,MAAO0B,EAAM1B,MACbuB,UAAWG,EAAMH,iBAMfK,YAAc,SAAC3F,GACrB,OAAOC,EAAKiF,SAASpD,YAAY9B,0CAGnC4F,kBAAA,WACEC,QAAQC,IAAI,uBACZD,QAAQC,IAAI9G,KAAKpB,MAAMmI,YAGlBC,OAAP,WAAgB,IAAAtF,EAAA1B,KACd6G,QAAQC,IAAI,UADE,IAAAG,EAEuCjH,KAAKpB,MAAlDI,EAFMiI,EAENjI,QAASS,EAFHwH,EAEGxH,MAAOd,EAFVsI,EAEUtI,OAAQgB,EAFlBsH,EAEkBtH,QAASoH,EAF3BE,EAE2BF,QACnCzC,EAAa2B,cAAciB,UAAU,CAAC,CAAC,GAAI,IAAK,CAACzH,EAAQ,GAAId,EAAS,KAAMgB,GAClFkH,QAAQC,IAAIxC,EAAWS,SACvB,IAAMoC,EAAgBC,YAAQ9C,GACxB+C,EAAarH,KAAKmG,oBAAoB7B,GAE5CuC,QAAQC,IAAIO,GACZR,QAAQC,IAAIxC,EAAWS,SAEvB,IAAIuC,EAA6BtH,KAAKkG,SAASvD,mBAAmB0E,GAWlE,OATIrH,KAAKkG,SAAS1D,eAAe6E,KAC/BR,QAAQC,IAAI,sBACZ9G,KAAK2G,YAAYU,GAAY7F,KAAK,SAAAwB,GAChCtB,EAAK6F,SAAS,CAAExB,YAAa,YAC7Bc,QAAQC,IAAI,oBACZD,QAAQC,IAAI9D,MAKdnE,OAAAmG,EAAA,EAAAnG,CAAA,OAAKE,UAAWC,EAAQP,KAAMgB,MAAOA,EAAOd,OAAQA,GAClDE,OAAAmG,EAAA,EAAAnG,CAAA,SACEA,OAAAmG,EAAA,EAAAnG,CAAC2I,EAAD,CAAiBjC,GAAG,cACpB1G,OAAAmG,EAAA,EAAAnG,CAAA,KAAGgE,OAAO,kBAAkB9D,UAAWC,EAAQgC,MAAOmE,MAAO,CAAEsC,QAAoC,YAA3BzH,KAAK8F,MAAMC,YAA4B,EAAI,IAChHuB,EAAYjG,IAAI,SAAChB,EAAMmG,GAAP,OACf3H,OAAAmG,EAAA,EAAAnG,CAAA,SACE6I,IAAKlB,EACLmB,UAAWtH,EAAKH,IAChBI,GAAKD,EAAKC,EAAID,EAAKiG,UAAU,IAAMjG,EAAK0E,MAAS1E,EAAKqG,IACtDnG,GAAKF,EAAKE,EAAIF,EAAKiG,UAAU,IAAMjG,EAAK0E,MAAS1E,EAAKqG,IACtDjH,MAAOY,EAAK0E,MAAQ1E,EAAKqG,IACzB/H,OAAQ0B,EAAK0E,MAAQ1E,EAAKqG,UAKlC7H,OAAAmG,EAAA,EAAAnG,CAAA,QAAME,UAAWC,EAAQb,OAAQyJ,EAAGT,EAAKxH,SAAY4C,IACrD1D,OAAAmG,EAAA,EAAAnG,CAAA,KAAGE,UAAWC,EAAQ6I,OAAQ1C,MAAO,CAAEsC,QAAoC,YAA3BzH,KAAK8F,MAAMC,YAA4B,EAAI,IACxFgB,EACGA,EAAQe,SAASzG,IAAI,SAAC0G,EAAKvB,GAAN,MACG,UAAtBuB,EAAIrD,SAASc,KAAmB3G,OAAAmG,EAAA,EAAAnG,CAACmJ,EAAD,CAAaN,IAAKlB,EAAO7G,QAASoI,EAAKzD,WAAYA,IAAiB,OAEtG,MAENzF,OAAAmG,EAAA,EAAAnG,CAAA,SACEA,OAAAmG,EAAA,EAAAnG,CAAA,SAAO8I,UAAWM,IAAO3H,EAAGb,EAAQ,EAAGc,EAAG5B,EAAS,EAAGc,MAAO,GAAId,OAAQ,GAAIuJ,UAAU,8BAnF/EC,aA0FH7J,QA1HA,SAACC,GAAD,OACbC,IAAa,CACXC,KAAM,GACNuC,MAAO,CACLoH,WAAY,cAEdjK,OAAQ,CACN8G,KAAM,OACNoD,OAAQ9J,EAAM+J,QAAQC,QAAQC,KAC9BC,YAAa,GAEfZ,OAAQ,CACNO,WAAY,qBA8GH9J,CAAmBuH","file":"component---src-pages-map-page-tsx-c8a04a3c1536d1aae6ad.js","sourcesContent":["import * as React from 'react';\nimport AppBar from '@material-ui/core/AppBar';\nimport ToolBar from '@material-ui/core/Toolbar';\nimport Typography from '@material-ui/core/Typography';\nimport { Theme } from '@material-ui/core/styles/createMuiTheme';\nimport withStyles, { WithStyles, StyleRules } from '@material-ui/core/styles/withStyles';\nimport createStyles from '@material-ui/core/styles/createStyles';\nimport { AutoSizer } from 'react-virtualized';\nimport circle from '@turf/circle';\nimport MapApp from '../components/MapApp';\n\nconst center = [140.46, 36.36];\nconst buffer = circle(center, 5000, {\n  units: 'meters'\n});\n\nconst styles = (theme: Theme): StyleRules =>\n  createStyles({\n    root: {},\n    autoSizerWrapper: {\n      height: 'calc(100vh - 56px)'\n    }\n  });\n\ninterface Props extends WithStyles<typeof styles> {}\n\nconst MapPage: React.FunctionComponent<Props> = (props: Props) => (\n  <div className={props.classes.root}>\n    <AppBar position=\"static\">\n      <ToolBar>\n        <Typography variant=\"h6\">Map Page</Typography>\n      </ToolBar>\n    </AppBar>\n    <div className={props.classes.autoSizerWrapper}>\n      <AutoSizer>{({ width, height }) => <MapApp width={width} height={height} feature={buffer} />}</AutoSizer>\n    </div>\n  </div>\n);\n\nexport default withStyles(styles)(MapPage);\n\n// helper\n","module.exports = \"data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAiIGZpbGw9IiMwMDkxRUEiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMSIvPgogICAgPHBhdGggZD0iTTEyIDExLjVjLTEuMzggMC0yLjUtMS4xMi0yLjUtMi41czEuMTItMi41IDIuNS0yLjUgMi41IDEuMTIgMi41IDIuNS0xLjEyIDIuNS0yLjUgMi41eiIgZmlsbD0id2hpdGUiLz4KICAgIDxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz4KPC9zdmc+Cg==\"","export interface Tile {\n  id: string;\n  x: number;\n  y: number;\n  z: number;\n  tx: number;\n  ty: number;\n  scale: number;\n  translate: [number, number];\n  mag: number;\n}\n\ntype TileUrl = string | undefined;\n\nexport interface TileWithURL extends Tile {\n  url: TileUrl;\n}\n\nexport interface TileTree {\n  [key: string]: {\n    [key: string]: {\n      [key: string]: TileUrl;\n    };\n  };\n}\n\ninterface TileSetOptions {\n  url?: string;\n}\n\nclass TileSet {\n  readonly tileTree: TileTree;\n  readonly tileUrl: string;\n  constructor(options: TileSetOptions = {}) {\n    this.tileUrl = options.url || '//cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png';\n    this.tileTree = {};\n  }\n\n  private treeIncludesTile(tile: Tile): boolean {\n    const { x, y, z } = tile;\n    return (\n      this.tileTree.hasOwnProperty(z.toString()) &&\n      this.tileTree[z.toString()].hasOwnProperty(x.toString()) &&\n      this.tileTree[z.toString()][x.toString()].hasOwnProperty(y.toString())\n    );\n  }\n\n  private tile2tree(tile: TileWithURL) {\n    const { x, y, z, url } = tile;\n    if (!this.tileTree.hasOwnProperty(z.toString())) {\n      this.tileTree[z.toString()] = {\n        [x.toString()]: {\n          [y.toString()]: url\n        }\n      };\n    } else if (!this.tileTree[z.toString()].hasOwnProperty(x.toString())) {\n      this.tileTree[z.toString()][x.toString()] = {\n        [y.toString()]: url\n      };\n    } else {\n      this.tileTree[z.toString()][x.toString()][y.toString()] = url;\n    }\n  }\n  // fetch new tiles\n  private fetchTiles(tiles: Tile[]): Promise<TileWithURL[]> {\n    return new Promise(resolve => {\n      const tasks = tiles.map(tile => this.fetchTile(tile, this.tileUrl));\n      Promise.all(tasks).then((data: TileWithURL[]) => {\n        resolve(data);\n      });\n    });\n  }\n  private fetchTile(tile: Tile, url: string): Promise<TileWithURL> {\n    const { x, y, z } = tile;\n    const fetchUrl = url.replace('{z}/{x}/{y}', `${z}/${x}/${y}`);\n\n    return fetch(fetchUrl)\n      .then(res => {\n        if (!res.ok) throw new Error();\n        return res.blob();\n      })\n      .then(blob => {\n        const tileWithURL: TileWithURL = {\n          ...tile,\n          url: URL.createObjectURL(blob)\n        };\n        this.tile2tree(tileWithURL);\n        return tileWithURL;\n      })\n      .catch(() => {\n        const tileWithURL: TileWithURL = {\n          ...tile,\n          url: undefined\n        };\n        this.tile2tree(tileWithURL);\n        return tileWithURL;\n      });\n  }\n\n  // helpers\n\n  public isRequireFetch(tiles: Tile[]): boolean {\n    return !tiles.every(tile => this.treeIncludesTile(tile));\n  }\n\n  public setTileUrlFromTree(tiles: Tile[]): TileWithURL[] {\n    return tiles\n      .filter(tile => this.treeIncludesTile(tile))\n      .map(tile => ({\n        ...tile,\n        url: this.tileTree[tile.z][tile.x][tile.y]\n      }));\n  }\n\n  public async updateTiles(newTiles: Tile[]) {\n    const tilesInTree = this.setTileUrlFromTree(newTiles.filter(tile => this.treeIncludesTile(tile)));\n\n    const tilesShouldFetch = newTiles.filter(tile => !this.treeIncludesTile(tile));\n\n    const fetchedTiles: TileWithURL[] = await this.fetchTiles(tilesShouldFetch);\n\n    return [...tilesInTree, ...fetchedTiles];\n  }\n}\n\nexport default TileSet;\n","import * as React from 'react';\nimport { scaleLinear, scaleSequential } from 'd3-scale';\nimport { interpolateSpectral } from 'd3-scale-chromatic';\nimport { Feature } from '@turf/helpers';\nimport { GeoProjection } from 'd3-geo';\n\ninterface MeshFeature extends Feature {\n  properties: {\n    val: number;\n  };\n}\n\ninterface Props {\n  feature: MeshFeature;\n  projection: GeoProjection;\n}\n\nconst colorScale = scaleSequential(interpolateSpectral /*interpolateYlOrRd*/).domain([1000, 0]);\nconst sizeScale = scaleLinear()\n  .domain([0, 1000])\n  .range([2, 8]);\n\nconst MeshRect: React.FunctionComponent<Props> = (props: Props) => {\n  const { feature, projection } = props;\n  const { val } = feature.properties;\n  const center = projection(feature.geometry.coordinates);\n  const size = Math.abs((sizeScale(val) * projection.scale()) / 175216);\n\n  return (\n    <rect\n      fill={colorScale(val)}\n      fillOpacity={0.6}\n      x={center[0] - size / 2}\n      y={center[1] - size / 2}\n      width={size}\n      height={size}\n      style={{ mixBlendMode: 'multiply' }}\n    />\n  );\n};\n\nexport default MeshRect;\n","import * as React from 'react';\n/*\nconst filterMatrix = [\n  \"0.3333 0.3333 0.3333 0 0\",\n  \"0.3333 0.3333 0.3333 0 0\",\n  \"0.3333 0.3333 0.3333 0 0\",\n  \"0 0 0 1 0\"\n];\n*/\nconst filterMatrix = ['0.3333 0.3333 0.3333 0 0', '0.3333 0.3333 0.3333 0 0', '0.3333 0.3333 0.3333 0 0', '0 0 0 1 0'];\n\ninterface Props {\n  id: string;\n}\n\nconst GrayScaleFilter: React.FunctionComponent<Props> = (props: Props) => (\n  <filter id={props.id}>\n    <feColorMatrix type=\"matrix\" values={filterMatrix.join(' ')} />\n  </filter>\n);\n\nexport default GrayScaleFilter;\n","import * as React from 'react';\nimport { Theme } from '@material-ui/core/styles/createMuiTheme';\nimport withStyles, { WithStyles, StyleRules } from '@material-ui/core/styles/withStyles';\nimport createStyles from '@material-ui/core/styles/createStyles';\nconst d3tile = require('d3-tile').tile;\n\nimport { geoMercator, geoPath, GeoProjection, GeoPath, ExtendedFeature } from 'd3-geo';\nimport centroid from '@turf/centroid';\nimport TileSet, { Tile, TileWithURL } from '../utils/tileTree';\nimport MeshFeature from '../components/MeshFeature';\nimport GrayScaleFilter from '../components/GrayScaleFilter';\nimport { GeoJSONObject } from '@turf/helpers';\n\nimport Place from '../image/place.svg';\n\nconst styles = (theme: Theme): StyleRules =>\n  createStyles({\n    root: {},\n    tiles: {\n      transition: 'opacity 1s'\n    },\n    buffer: {\n      fill: 'none',\n      stroke: theme.palette.primary.main,\n      strokeWidth: 2\n    },\n    points: {\n      transition: 'opacity 1s .5s'\n    }\n  });\n\ninterface D3TileArray<T> extends Array<T> {\n  scale: number;\n  translate: [number, number];\n}\n\ninterface Props extends WithStyles<typeof styles> {\n  width: number;\n  height: number;\n  geojson?: GeoJSONObject;\n  feature?: ExtendedFeature;\n}\n\ninterface State {\n  readonly fetchStatus?: 'yet' | 'fetching' | 'fetched';\n}\n\nclass Map extends React.Component<Props, State> {\n  readonly state: State = {\n    fetchStatus: 'yet'\n  };\n  _projection: GeoProjection = geoMercator();\n  _tileSet = new TileSet({ url: '//cyberjapandata.gsi.go.jp/xyz/slopemap/{z}/{x}/{y}.png' });\n\n  private _getTileCoordinates = (projection: GeoProjection): Tile[] => {\n    const { width, height } = this.props;\n    const mag: number = 1.5;\n\n    const tiles: Tile[] = d3tile()\n      .size([width * mag, height * mag])\n      .scale(projection.scale() * 2 * Math.PI * mag)\n      .translate(projection([0, 0]).map(v => v * mag))()\n      .map((tile: { x: number; y: number; z: number }, index: number, array: D3TileArray<Tile>) => ({\n        ...tile,\n        mag,\n        id: `${tile.z}/${tile.x}/${tile.y}`,\n        scale: array.scale,\n        translate: array.translate\n      }));\n\n    return tiles;\n  };\n\n  private _fetchTiles = (tiles: Tile[]) => {\n    return this._tileSet.updateTiles(tiles);\n  };\n\n  componentDidMount() {\n    console.log('Component Did Mount');\n    console.log(this.props.geojson);\n  }\n\n  public render() {\n    console.log('Render');\n    const { classes, width, height, feature, geojson } = this.props;\n    const projection = geoMercator().fitExtent([[20, 20], [width - 20, height - 20]], feature);\n    console.log(projection.scale());\n    const path: GeoPath = geoPath(projection);\n    const tileCoords = this._getTileCoordinates(projection);\n\n    console.log(tileCoords);\n    console.log(projection.scale());\n\n    let renderTiles: TileWithURL[] = this._tileSet.setTileUrlFromTree(tileCoords);\n\n    if (this._tileSet.isRequireFetch(tileCoords) /*tiles.length !== tileCoords.length*/) {\n      console.log('Fetch Tiles Starts');\n      this._fetchTiles(tileCoords).then(newTiles => {\n        this.setState({ fetchStatus: 'fetched' });\n        console.log('Fetch Tiles Ends');\n        console.log(newTiles);\n      });\n    }\n\n    return (\n      <svg className={classes.root} width={width} height={height}>\n        <g>\n          <GrayScaleFilter id=\"grayscale\" />\n          <g filter=\"url(#grayscale)\" className={classes.tiles} style={{ opacity: this.state.fetchStatus === 'fetched' ? 1 : 0 }}>\n            {renderTiles.map((tile, index) => (\n              <image\n                key={index}\n                xlinkHref={tile.url}\n                x={((tile.x + tile.translate[0]) * tile.scale) / tile.mag}\n                y={((tile.y + tile.translate[1]) * tile.scale) / tile.mag}\n                width={tile.scale / tile.mag}\n                height={tile.scale / tile.mag}\n              />\n            ))}\n          </g>\n        </g>\n        <path className={classes.buffer} d={path(feature) || undefined} />\n        <g className={classes.points} style={{ opacity: this.state.fetchStatus === 'fetched' ? 1 : 0 }}>\n          {geojson\n            ? geojson.features.map((ftr, index) =>\n                ftr.geometry.type === 'Point' ? <MeshFeature key={index} feature={ftr} projection={projection} /> : null\n              )\n            : null}\n        </g>\n        <g>\n          <image xlinkHref={Place} x={width / 2} y={height / 2} width={28} height={28} transform=\"translate(-14, -26)\" />\n        </g>\n      </svg>\n    );\n  }\n}\n\nexport default withStyles(styles)(Map);\n"],"sourceRoot":""}